/*
 * Copyright (c) 1998-2014 Erez Zadok
 * Copyright (c) 2009	   Shrikar Archak
 * Copyright (c) 2003-2014 Stony Brook University
 * Copyright (c) 2003-2014 The Research Foundation of SUNY
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */
#include "amfsctl.h"

/*This function displays help in user space call for ioctl*/
int help(int r)
{
	if (r < 0)
		printf("\n The command entered is not proper\n ");
	printf("\n Help\n ");
	printf("\n-------------------------------------------------------------------------------------\n");
	printf("\nEnter one or more option as under :\n\n");
	printf("\n1. To list known patterns ./amfsctl -l /mnt/amfs");
	printf("\n2. To add a new pattern ./amfsctl -a \"newpatt\" /mnt/amfs");
	printf("\n3. To remove an old pattern ./amfsctl -r \"oldpatt\" /mnt/amfs");
	printf("\n-------------------------------------------------------------------------------------\n");
	return r;
}

int main(int argc, char **argv)
{
	char *cvalue = NULL, *output = NULL;
	int flag = 0;
	char buf[4096];
	char *pattern = NULL;
	int file_desc = 0;
	char *mount_path = NULL;
	int index;
	int c;
	int rc = 0;
	int i = 0;
	int j = 0;
	char str[256];
	int count = 0;
	FILE *file = NULL;

	opterr = 0;
	memset(buf, '\0', 4096);
	while ((c = getopt(argc, argv, "la:r:h")) != -1)
		switch (c)
		{
			case 'l':
				flag = 1;
				break;
			case 'a':
				cvalue = optarg;
				strcpy(str, cvalue);
				flag = 2;
				break;
			case 'r':
				cvalue = optarg;
				strcpy(str, cvalue);
				flag = 3;
				break;
			case 'h':
				help(0);
				return 0;
			case '?':
				if (optopt == 'l')
					fprintf(stderr, "Option -%c requires an argument.\n", optopt);
				else if (optopt == 'a')
					fprintf(stderr, "Option -%c requires an argument.\n", optopt);
				else if (optopt == 'r')
					fprintf(stderr, "Option -%c requires an argument.\n", optopt);
				else if (isprint (optopt))
					fprintf(stderr, "Unknown option `-%c'.\n", optopt);
				else
					fprintf(stderr, "Unknown option character `\\x%x'.\n", optopt);
				return 1;
			default:
				abort();
		}
	for (index = optind; index < argc; index++)
	{
		mount_path = argv[index];
	}
	file_desc = open(mount_path, O_RDONLY, 0);
	if (file_desc < 0) {
		printf("Can't open mount point ");
		exit(-1);
	}

	switch (flag)
	{
		case 1:
				if (ioctl(file_desc, IOCTL_LIST, buf) < 0)
				{
					/*printf("ioctl_set_msg failed:%d\n", rc);*/
				}
				printf("\n Pattern list : %s", buf);
				break;
		case 2:
				if (ioctl(file_desc, IOCTL_ADD, str) < 0)
				{
					/*printf("ioctl_set_msg failed:%d\n", rc);*/
				}
				break;
		case 3:
				if (ioctl(file_desc, IOCTL_REMOVE, str) < 0)
				{
					/*printf("ioctl_set_msg failed:%d\n", rc);*/
				}
				break;
	}
	rc = close(file_desc);
	return rc;
}
